//------------------------------------------------------------------------------
// <auto-generated>
//   This file was generated by T4 code generator Model2.tt.
//   Any changes made to this file manually may cause incorrect behavior
//   and will be lost next time the file is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using System.Security.Permissions;
using System.ServiceModel;
using System.ServiceModel.Activation;
using System.Transactions;
using NTier.Common.Domain.Model;
using NTier.Server.Domain.Repositories;
using NTier.Server.Domain.Service;
using TableInheritance.Common.Domain.Model.TableInheritanceDemoDB;
using TableInheritance.Common.Domain.Service.Contracts;
using TableInheritance.Server.Domain.Repositories;


namespace TableInheritance.Server.Domain.Service
{
    public partial class TableInheritanceDemoDBDataService : DataService<ITableInheritanceDemoDBRepository>, ITableInheritanceDemoDBDataService
    {
        #region fields
 
        private static Func<ClientInfo, ITableInheritanceDemoDBRepository> _defaultRepositoryFactory = clientInfo => new TableInheritanceDemoDBRepository();
        private readonly Func<ClientInfo, ITableInheritanceDemoDBRepository> _repositoryFactory;
 
        #endregion fields
 
        #region constructor
 
        public TableInheritanceDemoDBDataService()
            : this(_defaultRepositoryFactory)
        {
        }
 
        public TableInheritanceDemoDBDataService(Func<ClientInfo, ITableInheritanceDemoDBRepository> repositoryFactory)
        {
            if (ReferenceEquals(null, repositoryFactory)) throw new ArgumentNullException("repositoryFactory");
            _repositoryFactory = repositoryFactory;
        }
 
        #endregion constructor

        #region query service methods

        partial void PreProcessing(ClientInfo clientInfo, ref Query query, ITableInheritanceDemoDBRepository repository);
        partial void PostProcessing(ClientInfo clientInfo, Query query, ref QueryResult<Person> result, ITableInheritanceDemoDBRepository repository);
        partial void PostProcessing(ClientInfo clientInfo, Query query, ref QueryResult<Address> result, ITableInheritanceDemoDBRepository repository);
        partial void PostProcessing(ClientInfo clientInfo, Query query, ref QueryResult<Demographic> result, ITableInheritanceDemoDBRepository repository);
        partial void PostProcessing(ClientInfo clientInfo, Query query, ref QueryResult<EmployeeRole> result, ITableInheritanceDemoDBRepository repository);

        [OperationBehavior(Impersonation = ImpersonationOption.Allowed)]
        public QueryResult<Person> GetPeople(ClientInfo clientInfo, Query query)
        {
            using (var dataRepository = _repositoryFactory(clientInfo))
            {
                PreProcessing(clientInfo, ref query, dataRepository);
                var result = Get(dataRepository.People.AsNoTrackingQueryable(), query, clientInfo);
                PostProcessing(clientInfo, query, ref result, dataRepository);
                return result;
            }
        }

        [OperationBehavior(Impersonation = ImpersonationOption.Allowed)]
        public QueryResult<Address> GetAddresses(ClientInfo clientInfo, Query query)
        {
            using (var dataRepository = _repositoryFactory(clientInfo))
            {
                PreProcessing(clientInfo, ref query, dataRepository);
                var result = Get(dataRepository.Addresses.AsNoTrackingQueryable(), query, clientInfo);
                PostProcessing(clientInfo, query, ref result, dataRepository);
                return result;
            }
        }

        [OperationBehavior(Impersonation = ImpersonationOption.Allowed)]
        public QueryResult<Demographic> GetDemographics(ClientInfo clientInfo, Query query)
        {
            using (var dataRepository = _repositoryFactory(clientInfo))
            {
                PreProcessing(clientInfo, ref query, dataRepository);
                var result = Get(dataRepository.Demographics.AsNoTrackingQueryable(), query, clientInfo);
                PostProcessing(clientInfo, query, ref result, dataRepository);
                return result;
            }
        }

        [OperationBehavior(Impersonation = ImpersonationOption.Allowed)]
        public QueryResult<EmployeeRole> GetEmployeeRoles(ClientInfo clientInfo, Query query)
        {
            using (var dataRepository = _repositoryFactory(clientInfo))
            {
                PreProcessing(clientInfo, ref query, dataRepository);
                var result = Get(dataRepository.EmployeeRoles.AsNoTrackingQueryable(), query, clientInfo);
                PostProcessing(clientInfo, query, ref result, dataRepository);
                return result;
            }
        }

        #endregion query service methods

        #region update service method

        partial void PreProcessing(ClientInfo clientInfo, ref TableInheritanceDemoDBChangeSet changeSet, ITableInheritanceDemoDBRepository repository);
        partial void BeforeSaving(ClientInfo clientInfo, ref TableInheritanceDemoDBChangeSet changeSet, ITableInheritanceDemoDBRepository repository);
        partial void PostProcessing(ClientInfo clientInfo, ref TableInheritanceDemoDBResultSet result, ITableInheritanceDemoDBRepository repository);

        [OperationBehavior(TransactionScopeRequired = true, Impersonation = ImpersonationOption.Allowed)]
        public TableInheritanceDemoDBResultSet SubmitChanges(ClientInfo clientInfo, TableInheritanceDemoDBChangeSet changeSet)
        {
            var resultSet = new TableInheritanceDemoDBResultSet(changeSet);
            using (var transactionScope = CreateSavingTransactionScope())
            {
                using (var dataRepository = _repositoryFactory(clientInfo))
                {
                    // optional custom processing
                    PreProcessing(clientInfo, ref changeSet, dataRepository);

                    // apply chnages to repository
                    ApplyChanges(dataRepository, dataRepository.People, changeSet, changeSet.People, clientInfo);
                    ApplyChanges(dataRepository, dataRepository.Addresses, changeSet, changeSet.Addresses, clientInfo);
                    ApplyChanges(dataRepository, dataRepository.Demographics, changeSet, changeSet.Demographics, clientInfo);
                    ApplyChanges(dataRepository, dataRepository.EmployeeRoles, changeSet, changeSet.EmployeeRoles, clientInfo);

                    // optional custom processing
                    BeforeSaving(clientInfo, ref changeSet, dataRepository);

                    // save changes
                    SaveChanges(dataRepository, changeSet, resultSet);

                    // optional custom processing
                    PostProcessing(clientInfo, ref resultSet, dataRepository);
                }
                transactionScope.Complete();
            }
            return resultSet;
        }

        protected override FaultException CreateUpdateFaultException(string message, IEnumerable<Entity> entities)
        {
            return new FaultException<TableInheritanceDemoDBUpdateFault>(new TableInheritanceDemoDBUpdateFault(message, entities), "Update error");
        }

        protected override FaultException CreateOptimisticConcurrencyFaultException(string message, IEnumerable<Entity> entities)
        {
            return new FaultException<TableInheritanceDemoDBOptimisticConcurrencyFault>(new TableInheritanceDemoDBOptimisticConcurrencyFault(message, entities), "Optimistic concurrency error");
        }

        #endregion update service method
    }
}

