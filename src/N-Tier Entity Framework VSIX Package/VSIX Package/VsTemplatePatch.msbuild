<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <SolutionDir Condition=" '$(SolutionDir)' == '' ">$(MSBuildProjectDirectory)\..\</SolutionDir>
    <BuildPath Condition=" '$(BuildPath)' == '' ">$(MSBuildProjectDirectory)</BuildPath>
    <ExtensionTasksPath Condition="Exists('$(SolutionDir)\..\..\tools\build\ExtensionPack\MSBuild.ExtensionPack.dll')">$(SolutionDir)\..\..\tools\build\ExtensionPack\</ExtensionTasksPath>
  </PropertyGroup>

  <Import Project="$(ExtensionTasksPath)\MSBuild.ExtensionPack.tasks" />

  <ItemGroup>
    <Namespaces Include="Mynamespace">
      <Prefix>x</Prefix>
      <Uri>http://schemas.microsoft.com/developer/vstemplate/2005</Uri>
    </Namespaces>  
    <VsTemplates Include="$(SolutionDir)\ProjectTemplates\**\*.vstemplate" />
    <VsTemplates Include="$(SolutionDir)\ItemTemplates\**\*.vstemplate" />
  </ItemGroup>
  
  <Target Name="PatchVsixId">
    <Message Text="-----------------------------------------------------------------------" />
    <Exec Command="echo patch vsix id in VSTemplate/WizardData/packages/@repositoryId" />
    <Exec Command="echo vsix guid:   &quot;$(VsixGuid)&quot;" />
    <Exec Command="echo vs template: &quot;%(VsTemplates.Identity)&quot;" />
    <MSBuild.ExtensionPack.Xml.XmlFile 
      Condition=" '$(VsixGuid)' != '' And '@(VsTemplates)' != '' "
      TaskAction="UpdateElement" 
      File="%(VsTemplates.Identity)" 
      XPath="/x:VSTemplate/x:WizardData/x:packages[starts-with(@repositoryId, 'NTierEntityFramework.Trivadis')]/@repositoryId"
      InnerText="NTierEntityFramework.Trivadis.$(VsixGuid)" 
      Namespaces="@(Namespaces)"/>
  </Target>
  
  <Target Name="PatchEFPackageVersions">
    <Message Text="-----------------------------------------------------------------------" />
    <Exec Command="echo patch entity framework provider version in VSTemplate/WizardData/packages/package/@id" />
    <Exec Command="echo EF provider version:  &quot;$(EFProviderVersion)&quot;" />
    <Exec Command="echo EF version:  &quot;$(EFVersion)&quot;" />
    <Exec Command="echo vs template: &quot;%(VsTemplates.Identity)&quot;" />

    <!-- Patch EF repository version -->
    <MSBuild.ExtensionPack.Xml.XmlFile 
      Condition=" '$(EFProviderVersion)' != '' And '@(VsTemplates)' != '' "
      TaskAction="UpdateElement" 
      File="%(VsTemplates.Identity)" 
      XPath="/x:VSTemplate/x:WizardData/x:packages/x:package[starts-with(@id, 'NTierEntityFramework.Server.EntityFramework')]/@id"
      InnerText="NTierEntityFramework.Server.EntityFramework$(EFProviderVersion)" 
      Namespaces="@(Namespaces)"/>

    <!-- Patch EF T4 template version -->
    <MSBuild.ExtensionPack.Xml.XmlFile 
      Condition=" '$(EFProviderVersion)' != '' And '@(VsTemplates)' != '' "
      TaskAction="UpdateElement" 
      File="%(VsTemplates.Identity)" 
      XPath="/x:VSTemplate/x:WizardData/x:packages/x:package[starts-with(@id, 'NTierEntityFramework.T4.EntityFramework')]/@id"
      InnerText="NTierEntityFramework.T4.EntityFramework$(EFProviderVersion)" 
      Namespaces="@(Namespaces)"/>

    <!-- Patch EF version -->
    <MSBuild.ExtensionPack.Xml.XmlFile 
      Condition=" '$(EFVersion)' != '' And '@(VsTemplates)' != '' "
      TaskAction="UpdateElement" 
      File="%(VsTemplates.Identity)" 
      XPath="/x:VSTemplate/x:WizardData/x:packages/x:package[@id='EntityFramework']/@version"
      InnerText="$(EFVersion)" 
      Namespaces="@(Namespaces)"/>
  </Target>
</Project>